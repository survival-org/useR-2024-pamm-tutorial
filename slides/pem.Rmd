

---
class: inverse, middle, center

.font150[
**Part II: Intro to PEMs and PAMMs**
]

<html>
  <div style=---float:left></div>
  <hr color='#005500' size=1px width=900px>
</html>

```{r input-setup-pem, child="setup-pem.Rmd", eval = TRUE}
```

---
# Piecewise exponential model (PEM)

**Cox PH model:** $$h(t|\bfx_i) = h_0(t) \exp(\bfx_i^\top\bsbeta) = \exp(g_0(t) + \bfx_i^\top \bsbeta)$$
where the baseline hazard is written as $g_0(t) = \log h_0(t)$. <br>
We now want to estimate both $h_0(t)$ as well as the parameters
$\bsbeta$ via ML.

We decompose the time axis into $J$ intervals, using cut points $a_0, a_1, \ldots, a_J$:
$$(0=a_0,a_1],(a_1,a_2],\ldots,(a_{j-1},a_j],\ldots,(a_{J-1},a_J]$$
These interval cut points will often correspond to event and/or censoring times, but don't need to.

We assume piecewise constant hazards
$$h_0(t) = h_{0j} \quad \forall\, t \in I_j:=(a_{j-1},a_j]$$
with $\beta_{0j} = \log(h_{0j})$, this yields
$$h(t|\bfx_i) = h_{0j}\exp(\bfx_i^\top\bsbeta) = \exp(\beta_{0j} + \bfx_i^\top \bsbeta) = \exp(\eta_{ij})=: h_{ij} \quad \forall t \in I_j$$


---
# Piecewise Exponential Data (PED)

<div class="row">
<div class = "column", align = "center">
Data in "standard" time-to-event format <br>
</div>
<div class = "column", align = "center">
Data in PED format <br>
</div>
</div>

<div class = "row" align = "middle">
<div class = "column", align = "middle">
.middle[
<img src="figures/tab-standard.svg", width = "300px" align="middle"><br>
$\ra$ transform to PED using $a_0=0, a_1 = 1, a_2=1.5, a_3=3$
]
</div>

<div class = "column" align ="middle">
<img src="figures/tab-ped.svg", width = "400px" align="middle" >
</div>
</div>


---
count: false
# Piecewise Exponential Data (PED)

<div class="row">
<div class = "column", align = "center">
Data in "standard" time-to-event format <br>
</div>
<div class = "column", align = "center">
Data in PED format <br>
</div>
</div>

<div class = "row" align = "middle">
<div class = "column", align = "middle">
.middle[
<img src="figures/tab-standard.svg", width = "300px" align="middle"><br>
$\ra$ transform to PED using $a_0=0, a_1 = 1, a_2=1.5, a_3=3$
]
</div>

<div class = "column" align ="middle">
<img src="figures/tab-ped1.svg", width = "400px" align="middle" >
</div>
</div>



---
count: false
# Piecewise Exponential Data (PED)

<div class="row">
<div class = "column", align = "center">
Data in "standard" time-to-event format <br>
</div>
<div class = "column", align = "center">
Data in PED format <br>
</div>
</div>

<div class = "row" align = "middle">
<div class = "column", align = "middle">
.middle[
<img src="figures/tab-standard.svg", width = "300px" align="middle"><br>
$\ra$ transform to PED using $a_0=0, a_1 = 1, a_2=1.5, a_3=3$
]
</div>

<div class = "column" align ="middle">
<img src="figures/tab-ped2.svg", width = "400px" align="middle" >
</div>
</div>

- define: $\delta_{ij} = \begin{cases}1 & t_i \in I_j \text{ and } \delta_i = 1\\0 & \text{else}\end{cases}$

---
count: false
# Piecewise Exponential Data (PED)

<div class="row">
<div class = "column", align = "center">
Data in "standard" time-to-event format <br>
</div>
<div class = "column", align = "center">
Data in PED format <br>
</div>
</div>

<div class = "row" align = "middle">
<div class = "column", align = "middle">
.middle[
<img src="figures/tab-standard.svg", width = "300px" align="middle"><br>
$\ra$ transform to PED using $a_0=0, a_1 = 1, a_2=1.5, a_3=3$
]
</div>

<div class = "column" align ="middle">
<img src="figures/tab-ped3.svg", width = "400px" align="middle" >
</div>
</div>

- define: $\delta_{ij} = \begin{cases}1 & t_i \in I_j \text{ and } \delta_i = 1\\0 & \text{else}\end{cases}$,
$\quad t_{ij} = \begin{cases} a_j - a_{j-1} & a_j < t_i\\ t_i - a_{j-1} & a_{j-1} < t_i \leq a_j\end{cases}$



---
count: false
# Piecewise Exponential Data (PED)

<div class="row">
<div class = "column", align = "center">
Data in "standard" time-to-event format <br>
</div>
<div class = "column", align = "center">
Data in PED format <br>
</div>
</div>

<div class = "row" align = "middle">
<div class = "column", align = "middle">
.middle[
<img src="figures/tab-standard.svg", width = "300px" align="middle"><br>
$\ra$ transform to PED using $a_0=0, a_1 = 1, a_2=1.5, a_3=3$
]
</div>

<div class = "column" align ="middle">
<img src="figures/tab-ped4.svg", width = "400px" align="middle" >
</div>
</div>

- define: $\delta_{ij} = \begin{cases}1 & t_i \in I_j \text{ and } \delta_i = 1\\0 & \text{else}\end{cases}$,
$\quad t_{ij} = \begin{cases} a_j - a_{j-1} & a_j < t_i\\ t_i - a_{j-1} & a_{j-1} < t_i \leq a_j\end{cases}$,
$\quad t_j := a_j$


---
count: false
# Piecewise Exponential Data (PED)

<div class="row">
<div class = "column", align = "center">
Data in "standard" time-to-event format <br>
</div>
<div class = "column", align = "center">
Data in PED format <br>
</div>
</div>

<div class = "row" align = "middle">
<div class = "column", align = "middle">
.middle[
<img src="figures/tab-standard.svg", width = "300px" align="middle"><br>
$\ra$ transform to PED using $a_0=0, a_1 = 1, a_2=1.5, a_3=3$
]
</div>

<div class = "column" align ="middle">
<img src="figures/tab-ped.svg", width = "400px" align="middle" >
</div>
</div>

- define: $\delta_{ij} = \begin{cases}1 & t_i \in I_j \text{ and } \delta_i = 1\\0 & \text{else}\end{cases}$,
$\quad t_{ij} = \begin{cases} a_j - a_{j-1} & a_j < t_i\\ t_i - a_{j-1} & a_{j-1} < t_i \leq a_j\end{cases}$,
$\quad t_j := a_j$

- also known as "start-stop" data format, as used for interval-censoring and time-varying covariates in PH models


---
# PAM: Illustration
```{r, est-pem, echo=FALSE, fig.width = 6, fig.height=3, dependson=c("sim-wb", "ex-pem-1")}
ped2 <- as_ped(Surv(time, status)~., cut = seq(0,10, by=.1), data=sim_df_weibull)
pem2 <- glm(ped_status ~ interval, data = ped2, family=poisson(), offset=offset)
pem_haz_df2 <- int_info(ped2) %>%
  mutate(offset = intlen) %>%
  mutate(
    hazard = predict(object=pem2, ., type="response"),
    survival = exp(-cumsum(hazard * intlen)))
p_pem_haz2 <- p_pem_haz %+% pem_haz_df2 + ylim(c(0, .35))
```

```{r, est-pam, echo=FALSE, fig.width = 6, fig.height=3, dependson=c("est-pem")}
pam <- mgcv::gam(ped_status ~ s(tend), data = ped2, family=poisson(), offset=offset)
pem_haz_df2 <- pem_haz_df2 |> add_hazard(pam, overwrite = TRUE)
p_pam_haz <- p_pem_haz %+% pem_haz_df2 +
  geom_stepribbon(aes(ymin = ci_lower, ymax= ci_upper), alpha = .3) + ylim(c(0, .35))
```

```{r, echo=FALSE, fig.width = 9, fig.height = 3, dependson=c("est-pam"), out.width = "800px"}
pem_haz1 + ylim(c(0, .35)) + ggtitle("PEM: small J") + p_pem_haz2 + ggtitle("PEM: large J")  + p_pam_haz + ggtitle("PAM: large J")
```

- A good strategy is to select cut points at observed event times $t_{(1)},\ldots,t_{(m)}$ (basis functions will be evaluated in regions with many events, i.e., regions with a lot of information about the process)
- For large $m$, a small subsample will often be sufficient
- Number of parameters $L$ does not depend on number of cut points $J$ (but computation time still affected by $J$)<br><br>
- PEMs and PAMMs in **R** facilitated by package **`pammtools`**
- Various articles (vignettes) on different topics available at [adibender.github.io/pammtools](https://adibender.github.io/pammtools/articles/)
